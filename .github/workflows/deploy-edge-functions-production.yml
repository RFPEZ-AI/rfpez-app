name: Deploy Edge Functions to Production

on:
  workflow_dispatch: # Manual trigger only for production
    inputs:
      confirm_production:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string
      functions_to_deploy:
        description: 'Functions to deploy (comma-separated or "all")'
        required: true
        default: 'all'
        type: string

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "‚ùå Production deployment not confirmed. Aborting."
            echo "Please type exactly: DEPLOY TO PRODUCTION"
            exit 1
          fi
          echo "‚úÖ Production deployment confirmed"

  deploy-edge-functions:
    needs: validate-input
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_PROD_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROD_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase credentials
        run: |
          echo "üîç Verifying production Supabase credentials..."
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_PROD_ACCESS_TOKEN not set"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "‚ùå SUPABASE_PROD_PROJECT_REF not set"
            exit 1
          fi
          echo "‚úÖ Credentials verified"

      - name: Link to Supabase production project
        run: |
          echo "üîó Linking to production project..."
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }} --password ${{ env.SUPABASE_DB_PASSWORD }}

      - name: Deployment reminder
        run: |
          echo "‚ö†Ô∏è  PRODUCTION EDGE FUNCTION DEPLOYMENT"
          echo "======================================="
          echo "This will deploy edge functions to PRODUCTION"
          echo "Functions to deploy: ${{ github.event.inputs.functions_to_deploy }}"
          echo ""
          echo "Ensure you have:"
          echo "  1. Tested functions locally and in dev environment"
          echo "  2. Reviewed function code for production readiness"
          echo "  3. Verified environment variables are set correctly"
          echo "  4. Considered impact on active users"
          echo ""
          echo "Proceeding in 10 seconds..."
          sleep 10

      - name: Deploy claude-api-v3 function
        if: contains(github.event.inputs.functions_to_deploy, 'all') || contains(github.event.inputs.functions_to_deploy, 'claude-api-v3')
        run: |
          echo "üöÄ Deploying claude-api-v3 to production..."
          supabase functions deploy claude-api-v3 \
            --project-ref ${{ env.SUPABASE_PROJECT_REF }} \
            --no-verify-jwt
          echo "‚úÖ claude-api-v3 deployed"

      - name: Deploy supabase-mcp-server function
        if: contains(github.event.inputs.functions_to_deploy, 'all') || contains(github.event.inputs.functions_to_deploy, 'supabase-mcp-server')
        run: |
          echo "üöÄ Deploying supabase-mcp-server to production..."
          supabase functions deploy supabase-mcp-server \
            --project-ref ${{ env.SUPABASE_PROJECT_REF }}
          echo "‚úÖ supabase-mcp-server deployed"

      - name: List deployed functions
        run: |
          echo "üìã Listing production functions..."
          supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Deployment summary
        run: |
          echo "üéØ Production Edge Function Deployment Summary"
          echo "=============================================="
          echo "Environment: PRODUCTION (rfpez.ai)"
          echo "Project Ref: ${{ env.SUPABASE_PROJECT_REF }}"
          echo "Functions deployed: ${{ github.event.inputs.functions_to_deploy }}"
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Deployed by: ${{ github.actor }}"
          echo ""
          echo "Next steps:"
          echo "  1. Test edge function endpoints in production"
          echo "  2. Monitor function logs for errors"
          echo "  3. Verify API integration is working"
          echo "  4. Monitor performance metrics"
          echo "  5. Check for any user-reported issues"
          echo ""
          echo "Production function URLs:"
          echo "  claude-api-v3: https://${{ env.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/claude-api-v3"
          echo "  supabase-mcp-server: https://${{ env.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/supabase-mcp-server"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå PRODUCTION edge function deployment failed!"
          echo ""
          echo "Required actions:"
          echo "  1. Review error logs above"
          echo "  2. Check Supabase dashboard for function status"
          echo "  3. Test current production functions still work"
          echo "  4. Notify stakeholders if service is affected"
          echo "  5. Investigate root cause before retry"
