name: Deploy Migrations to Production

on:
  workflow_dispatch: # Manual trigger only for production
    inputs:
      confirm_production:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "[ERROR] Production deployment not confirmed. Aborting."
            echo "Please type exactly: DEPLOY TO PRODUCTION"
            exit 1
          fi
          echo "[SUCCESS] Production deployment confirmed"

  deploy-migrations:
    needs: validate-input
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_PROD_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROD_PROJECT_REF }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase credentials
        run: |
          echo "üîç Verifying production Supabase credentials..."
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "[ERROR] SUPABASE_PROD_ACCESS_TOKEN not set"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "[ERROR] SUPABASE_PROD_PROJECT_REF not set"
            exit 1
          fi
          echo "[SUCCESS] Credentials verified"

      - name: List pending migrations
        id: check_migrations
        run: |
          echo "üìã Checking pending migrations for production..."
          MIGRATION_COUNT=$(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)
          if [ "$MIGRATION_COUNT" -gt 0 ]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
            echo "[SUCCESS] Found $MIGRATION_COUNT migration file(s) to deploy"
            echo ""
            echo "Migration files to deploy:"
            ls -la supabase/migrations/*.sql
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
            echo "[INFO] No migration files found"
          fi

      - name: Backup reminder
        run: |
          echo "[WARNING]  PRODUCTION DEPLOYMENT REMINDER"
          echo "=================================="
          echo "This will deploy migrations to PRODUCTION database"
          echo "Ensure you have:"
          echo "  1. Tested all migrations in dev environment"
          echo "  2. Created a database backup (if not auto-backed up)"
          echo "  3. Reviewed all migration files for production readiness"
          echo "  4. Notified stakeholders of maintenance window (if needed)"
          echo ""
          echo "Proceeding in 10 seconds..."
          sleep 10

      - name: Configure Supabase project (skip database verification)
        run: |
          echo "[CONFIG] Configuring Supabase project..."
          mkdir -p .supabase
          echo '[project]' > .supabase/config.toml
          echo "project_id = \"${{ env.SUPABASE_PROJECT_REF }}\"" >> .supabase/config.toml
          echo "[SUCCESS] Project configured (using Management API only)"

      - name: Deploy migrations to production
        if: success() && steps.check_migrations.outputs.has_pending == 'true'
        run: |
          echo "üöÄ Deploying migrations to PRODUCTION..."
          echo "Project Ref: ${{ env.SUPABASE_PROJECT_REF }}"
          echo "Using Management API (no database connection needed)"
          echo ""
          
          # Deploy using Management API only
          # The SUPABASE_ACCESS_TOKEN environment variable is used automatically
          supabase db push 2>&1 | tee deploy.log
          
          if grep -q "Finished supabase db push" deploy.log; then
            echo "[SUCCESS] Migrations deployed successfully to PRODUCTION!"
          else
            echo "[WARNING] Checking deployment status..."
            cat deploy.log
            exit 1
          fi

      - name: Verify deployment
        if: steps.check_migrations.outputs.has_pending == 'true'
        run: |
          echo "[SUCCESS] PRODUCTION migration deployment completed!"
          echo ""
          echo "Deployed migration files:"
          ls -la supabase/migrations/*.sql
          echo ""
          echo "üîç Please verify in Supabase dashboard:"
          echo "   https://supabase.com/dashboard/project/${{ env.SUPABASE_PROJECT_REF }}"

      - name: Deployment summary
        run: |
          echo "üéØ Production Deployment Summary"
          echo "=================================="
          echo "Environment: PRODUCTION (rfpez.ai)"
          echo "Project Ref: ${{ env.SUPABASE_PROJECT_REF }}"
          if [ "${{ steps.check_migrations.outputs.has_pending }}" == "true" ]; then
            echo "Status: [SUCCESS] Migrations deployed successfully"
          else
            echo "Status: [INFO] No migrations to deploy"
          fi
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Deployed by: ${{ github.actor }}"
          echo ""
          echo "Next steps:"
          echo "  1. Verify migrations in Supabase dashboard"
          echo "  2. Test critical functionality in production"
          echo "  3. Monitor error logs for issues"
          echo "  4. Update deployment documentation"

      - name: Notify on failure
        if: failure()
        run: |
          echo "[ERROR] PRODUCTION migration deployment failed!"
          echo ""
          echo "Required actions:"
          echo "  1. Review error logs above"
          echo "  2. Check Supabase dashboard for database state"
          echo "  3. Determine if rollback is needed"
          echo "  4. Notify stakeholders of deployment failure"
          echo "  5. Do not attempt re-deployment without investigating root cause"
          echo ""
          echo "Common issues:"
          echo "  - Migration conflicts (already applied)"
          echo "  - Database connection issues"
          echo "  - Invalid SQL syntax"
          echo "  - Permission/access token issues"
