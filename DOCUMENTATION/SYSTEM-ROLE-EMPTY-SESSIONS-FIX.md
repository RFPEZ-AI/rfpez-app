# System Role Messages Creating Empty Sessions

**Date:** October 13, 2025  
**Issue:** Empty sessions with "No Agent" and system role messages  
**Root Cause:** `create_new_session` tool stores initial_prompt as system message  
**Status:** üî¥ **ACTIVE BUG** - Requires immediate fix

## Problem Analysis

### Remaining Empty Sessions
After cleanup of 70 empty welcome sessions, **2-9 additional empty sessions remain** with:
- **Role: `system`** (not `assistant`)
- **Content: Raw initial_prompt text** (full agent instructions)
- **Agent Name: NULL** (shows as "No Agent" in UI)
- **Titles**: Mix of "You are the Solutions agent..." and actual RFP names

### Database Evidence
```sql
-- Query showing system role messages
SELECT s.id, s.title, m.role, m.agent_name, m.content
FROM sessions s
LEFT JOIN messages m ON s.id = m.session_id
WHERE m.role = 'system'
ORDER BY m.created_at DESC;

-- Result: 15 system messages
-- First: 2025-10-11 23:17:28
-- Last:  2025-10-13 21:59:52 (just created!)
```

### Root Cause Location

**File:** `supabase/functions/claude-api-v3/tools/database.ts`  
**Lines:** 873-907  
**Function:** `createSession()`

```typescript
// üö® BUG: Stores initial_prompt as 'system' message immediately after session creation
const { error: messageError } = await supabase
  .from('messages')
  .insert({
    session_id: sessionId,
    user_id: (userProfile as unknown as { id: string }).id,
    content: agent.initial_prompt,  // ‚ùå Raw initial_prompt text
    role: 'system',                  // ‚ùå Should be 'assistant' if stored at all
    message_order: 1,
    metadata: {
      agent_name: agent.name,
      message_type: 'initial_welcome',
      auto_generated: true
    }
  });
```

### Why This Is Wrong

1. **Violates Lazy Session Creation Pattern**
   - Sessions should only be created when user sends first message
   - This creates database records immediately
   - Contradicts the entire lazy session implementation

2. **Wrong Message Role**
   - `system` role is for system prompts, not stored messages
   - Should be `assistant` if storing welcome messages
   - UI doesn't display system messages properly

3. **Raw Initial Prompt Instead of Processed**
   - Stores the agent's instruction text verbatim
   - Should store the **processed welcome message** from Claude
   - Results in confusing session titles

4. **Creates Sessions Without User Context**
   - Tool can be called before user interaction
   - Creates abandoned sessions if user doesn't follow through
   - Same issue lazy session creation was designed to prevent

## Impact

### Current State
- ‚úÖ 70 welcome sessions with `assistant` role cleaned up
- ‚ùå 15 system role messages remain (2 created in last hour)
- ‚ùå Cleanup function doesn't catch `role = 'system'`
- ‚ùå New empty sessions continue to accumulate

### User Experience
- Session history shows "No Agent" for these sessions
- Empty sessions clutter the sidebar
- Confusing session titles with instruction text

## Solution

### Option 1: Remove Initial Message Storage (Recommended) ‚úÖ

**Rationale:** The lazy session creation pattern already handles welcome messages correctly via React state. Database storage here is redundant and harmful.

**Changes:**
```typescript
// File: supabase/functions/claude-api-v3/tools/database.ts
// Lines: 867-907

// REMOVE THIS ENTIRE BLOCK:
// - Don't store initial_prompt as message
// - Don't create any messages on session creation
// - Let React handle welcome message display
// - Session gets messages only when user interacts

// Replace with:
console.log('‚úÖ V3: Session created - welcome message will be generated by React on load');
// No database message storage
```

### Option 2: Fix Message Storage (Alternative)

If we must store a message, do it correctly:

```typescript
// Only store if this is NOT a lazy session creation
// (i.e., session was created WITH user's first message)
if (data.first_user_message) {
  // Process initial_prompt through Claude to get dynamic welcome
  const dynamicWelcome = await processInitialPromptViaClaude(agent.initial_prompt);
  
  // Store as assistant message with proper agent attribution
  const { error: messageError } = await supabase
    .from('messages')
    .insert({
      session_id: sessionId,
      user_id: userProfile.id,
      content: dynamicWelcome,        // ‚úÖ Processed welcome
      role: 'assistant',               // ‚úÖ Correct role
      agent_id: agent.id,              // ‚úÖ Agent attribution
      agent_name: agent.name,          // ‚úÖ Agent name
      message_order: 1,
      metadata: {
        message_type: 'initial_welcome',
        auto_generated: true
      }
    });
}
```

### Option 3: Enhanced Cleanup Function (Immediate)

Update cleanup to catch system role messages:

```sql
-- File: database/cleanup-empty-welcome-sessions.sql
-- Update function to also catch system role messages

CREATE OR REPLACE FUNCTION cleanup_empty_welcome_sessions(
  max_age_hours INTEGER DEFAULT 1
)
RETURNS TABLE(
  session_id UUID,
  session_title TEXT,
  created_at TIMESTAMPTZ,
  message_count BIGINT
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN QUERY
  DELETE FROM sessions s
  WHERE 
    -- Empty sessions with welcome message titles OR any problematic pattern
    (
      s.title LIKE '%You are the Solutions agent%' OR 
      s.title LIKE '%agent welcoming a user%' OR
      s.title LIKE '%You are the%agent%'  -- Catch variations
    )
    -- Older than specified age
    AND s.created_at < NOW() - (max_age_hours || ' hours')::INTERVAL
    -- Has messages (system OR assistant)
    AND EXISTS (SELECT 1 FROM messages m WHERE m.session_id = s.id)
    -- But NO user messages
    AND NOT EXISTS (SELECT 1 FROM messages m WHERE m.session_id = s.id AND m.role = 'user')
    -- AND either has system messages OR no assistant messages with agent_name
    AND (
      EXISTS (SELECT 1 FROM messages m WHERE m.session_id = s.id AND m.role = 'system')
      OR NOT EXISTS (SELECT 1 FROM messages m WHERE m.session_id = s.id AND m.role = 'assistant' AND m.agent_name IS NOT NULL)
    )
  RETURNING s.id, s.title, s.created_at, 
    (SELECT COUNT(*) FROM messages m WHERE m.session_id = s.id);
END;
$$;
```

### Option 4: Prevent System Role Message Creation

Add validation to prevent storing messages with system role:

```typescript
// File: supabase/functions/claude-api-v3/tools/database.ts
// Before ANY message insert

if (role === 'system') {
  throw new Error('Invalid message role: system messages should not be stored in database. Use assistant role for agent messages.');
}
```

## Recommended Implementation Plan

### Phase 1: Immediate Cleanup ‚úÖ
1. Update cleanup function to catch system role messages
2. Run cleanup to remove existing 15 system messages
3. Verify no empty sessions remain

### Phase 2: Prevent New Creation (Critical) üî•
1. **Remove initial message storage** from `createSession()` (Option 1)
2. Add validation to prevent system role messages (Option 4)
3. Test session creation flow
4. Deploy to local and verify

### Phase 3: Monitoring
1. Monitor for new empty sessions over 24 hours
2. Check for any system role messages
3. Verify lazy session creation working as designed

## Implementation Code

### 1. Update Cleanup Function
```sql
-- Run this to update the cleanup function
-- (Code shown in Option 3 above)
```

### 2. Remove Initial Message Storage
```typescript
// File: supabase/functions/claude-api-v3/tools/database.ts
// Lines: 867-907

// DELETE OR COMMENT OUT this entire section:
/*
  try {
    const { data: defaultAgent, error: agentError } = await supabase
      .from('agents')
      .select('name, initial_prompt')
      .eq('is_default', true)
      .single();
    
    if (!agentError && defaultAgent) {
      // ... entire welcome message storage block
    }
  } catch (welcomeError) {
    // ... error handling
  }
*/

// REPLACE WITH:
console.log('‚úÖ V3: Session created successfully - welcome message handled by React UI');
console.log('üí° V3: No database message storage on session creation (lazy pattern)');
```

### 3. Run Updated Cleanup
```bash
# Update function in database
docker exec -i supabase_db_rfpez-app-local psql -U postgres -d postgres < database/cleanup-empty-welcome-sessions-v2.sql

# Run cleanup with 0 hour threshold (immediate)
docker exec supabase_db_rfpez-app-local psql -U postgres -d postgres -c \
  "SELECT * FROM cleanup_empty_welcome_sessions(0);"

# Verify no empty sessions remain
docker exec supabase_db_rfpez-app-local psql -U postgres -d postgres -c \
  "SELECT COUNT(*) FROM sessions s WHERE NOT EXISTS (SELECT 1 FROM messages m WHERE m.session_id = s.id AND m.role = 'user');"
```

## Testing

### Test 1: Verify System Messages Removed
```sql
SELECT COUNT(*) FROM messages WHERE role = 'system';
-- Expected: 0
```

### Test 2: New Session Creation
```bash
1. Open app (no sessions)
2. Verify welcome message shows (React state)
3. Don't send message, refresh page
4. Check database - no session created
# Expected: No new empty sessions
```

### Test 3: First Message Creates Session
```bash
1. Continue from Test 2
2. Send first message
3. Check database - session created with user message
# Expected: Session with proper title from first message
```

## Success Criteria

- ‚úÖ All system role messages removed from database
- ‚úÖ No new system role messages created
- ‚úÖ Lazy session creation working as designed
- ‚úÖ Session titles based on user input, not agent instructions
- ‚úÖ No "No Agent" sessions in UI

## Related Files
- `supabase/functions/claude-api-v3/tools/database.ts` - Session creation
- `supabase/functions/supabase-mcp-server/index.ts` - MCP session creation (also has system role)
- `database/cleanup-empty-welcome-sessions.sql` - Cleanup function
- `DOCUMENTATION/EMPTY-WELCOME-SESSIONS-FIX.md` - Previous fix documentation
